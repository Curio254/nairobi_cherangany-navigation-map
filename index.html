
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nairobi → Cherangany Navigation Map</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
    }
    #map {
        height: 100vh;
        width: 100%;
    }

    /* Mobile responsive */
    @media (max-width: 600px) {
        #map {
            height: 100vh;
        }
    }
</style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
// Global array to store all nursery coordinates for routing
const nurseryWaypoints = [];

// Fixed starting point = Nairobi City Centre (Kenyatta Avenue area)
const NAIROBI_START = L.latLng(-1.28333, 36.8167);

// Initialize map
var map = L.map('map').setView([0.7, 35.4], 8);

// Base map
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
}).addTo(map);

// GeoJSON files in root
var geojsonFiles = [
    {file: 'cherengany_fblock_wgs84.json', style:{color:'green', weight:3, fillOpacity:0.25}, name:'Cherangany Forest Block', type: 'polygon'},
    {file: 'elgeyo_marakwet_county.json', style:{color:'blue'}, name:'Elgeyo Marakwet Nurseries', type: 'point'},
    {file: 'west_pokot_county.json', style:{color:'orange'}, name:'West Pokot Nurseries', type: 'point'}
];

// Load promises tracker
const loadPromises = [];

// Load each GeoJSON layer
geojsonFiles.forEach(item => {
    const promise = fetch(item.file)
        .then(res => {
            if (!res.ok) throw new Error("Error loading: " + item.file);
            return res.json();
        })
        .then(data => {
            L.geoJSON(data, {
                style: item.style,
                pointToLayer: function(feature, latlng){
                    if (item.type === 'point') {
                        nurseryWaypoints.push(latlng);
                        return L.marker(latlng);
                    }
                },
                onEachFeature: function(feature, layer){
                    let popup = `<strong>${item.name}</strong>`;
                    if (feature.properties?.name) popup += `<br>${feature.properties.name}`;
                    layer.bindPopup(popup);
                }
            }).addTo(map);
        })
        .catch(err => console.error(err));

    loadPromises.push(promise);
});

// After all layers load → generate route
Promise.all(loadPromises).then(() => {

    if (nurseryWaypoints.length === 0) {
        console.warn("⚠️ No nursery points found in GeoJSON files.");
        return;
    }

    // Create ordered route waypoints:
    // Nairobi → all nursery points → last nursery
    const finalWaypoints = [
        L.Routing.waypoint(NAIROBI_START, "Nairobi (Start)"),
        ...nurseryWaypoints.map(pt => L.Routing.waypoint(pt)),
        L.Routing.waypoint(nurseryWaypoints[nurseryWaypoints.length - 1], "Final Nursery (End)")
    ];

    L.Routing.control({
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1'
        }),
        waypoints: finalWaypoints,
        routeWhileDragging: false,
        showAlternatives: true,
        lineOptions: {
            styles: [{ color: '#C2185B', weight: 6, opacity: 0.85 }]
        },
        language: 'en'
    }).addTo(map);

    map.setZoom(7);
});
</script>

</body>
</html>
