<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nairobi_cherangany-navigation-map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  #map { height: 100%; }

  /* Floating routing box */
  #routing-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 280px;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      font-family: sans-serif;
      z-index: 1000;
      overflow: hidden;
      max-height: 400px;
      transition: transform 0.3s ease, opacity 0.3s ease;
      transform: translateY(100%);
      opacity: 0;
  }
  #routing-container.visible {
      transform: translateY(0);
      opacity: 1;
  }
  #routing-header {
      background: #d495a5;
      color: white;
      font-weight: 600;
      padding: 10px;
      cursor: pointer;
      text-align: center;
  }
  #routing-panel { padding: 10px; }
  #routing-panel button {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: none;
      border-radius: 8px;
      background: #f1c0c0;
      cursor: pointer;
      font-weight: 600;
  }
  #routing-panel button:hover { background: #e5a2a2; }
</style>
</head>
<body>

<div id="map"></div>

<div id="routing-container">
  <div id="routing-header">üó∫Ô∏è Show / Hide Navigation</div>
  <div id="routing-panel">
      <button id="fastestBtn">Fastest Route</button>
      <button id="shortestBtn">Shortest Route</button>
      <button id="clearRouteBtn">Clear Route</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
// Nairobi fixed start
const NAIROBI_START = L.latLng(-1.28333, 36.8167);
const nurseryWaypoints = [];

// Initialize map
var map = L.map('map').setView([0.5, 35.5], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// GeoJSON files
var geojsonFiles = [
    {file: 'cherangany_fblock_wgs84.json', style:{color:'green', weight:3, fillOpacity:0.2}, name:'Cherangany Forest Block', type:'polygon'},
    {file: 'elgeyo_marakwet_county.json', style:{color:'blue', weight:2}, name:'Elgeyo Marakwet Nurseries', type:'point'},
    {file: 'west_pokot_county.json', style:{color:'orange', weight:2}, name:'West Pokot Nurseries', type:'point'}
];

const loadPromises = [];

geojsonFiles.forEach(item => {
    const promise = fetch(item.file)
        .then(res => {
            if(!res.ok) throw new Error('HTTP error! Status: ' + res.status + ' for ' + item.file);
            return res.json();
        })
        .then(data => {
            L.geoJSON(data, {
                style: item.style,
                pointToLayer: function(feature, latlng){
                    if(item.type==='point'){ nurseryWaypoints.push(latlng); return L.marker(latlng); }
                    return null;
                },
                onEachFeature: function(feature, layer){
                    let popup = "<strong>"+item.name+"</strong>";
                    if(feature.properties && feature.properties.name) popup += "<br>"+feature.properties.name;
                    layer.bindPopup(popup);
                }
            }).addTo(map);
        })
        .catch(err => console.error(err));
    loadPromises.push(promise);
});

let routingControl = null;

function createRoute(profile='fastest'){
    if(routingControl) map.removeControl(routingControl);

    if(nurseryWaypoints.length===0){
        console.warn("Nurseries not loaded yet.");
        return;
    }

    const finalWaypoints = [
        L.Routing.waypoint(NAIROBI_START, 'Nairobi (Start)'),
        ...nurseryWaypoints,
        L.Routing.waypoint(nurseryWaypoints[nurseryWaypoints.length-1], 'Final Nursery')
    ];

    routingControl = L.Routing.control({
        router: L.Routing.osrmv1({ serviceUrl:'https://router.project-osrm.org/route/v1', profile: profile }),
        waypoints: finalWaypoints,
        routeWhileDragging: false,
        show: true,
        language: 'en',
        lineOptions: { styles:[{color:'#D495A5', weight:6, opacity:0.8}] }
    }).addTo(map);

    map.setZoom(7);
}

Promise.all(loadPromises).then(()=>{ createRoute('fastest'); });

// Animate show/hide
const routingContainer = document.getElementById('routing-container');
document.getElementById('routing-header').addEventListener('click', ()=>{
    routingContainer.classList.toggle('visible');
});

// Buttons
document.getElementById('fastestBtn').addEventListener('click', ()=>createRoute('fastest'));
document.getElementById('shortestBtn').addEventListener('click', ()=>createRoute('shortest'));
document.getElementById('clearRouteBtn').addEventListener('click', ()=>{
    if(routingControl) map.removeControl(routingControl);
    routingControl = null;
});
</script>
</body>
</html>
